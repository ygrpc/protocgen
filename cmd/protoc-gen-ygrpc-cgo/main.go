package main

import (
	"fmt"
	"log"
	"os"
	"slices"

	"github.com/ygrpc/protocgen/protocplugin"
	"google.golang.org/protobuf/proto"
	"google.golang.org/protobuf/types/pluginpb"
)

func main() {
	logPrefix := "protoc-gen-ygrpc-cgo: "
	log.SetPrefix(logPrefix)

	_, _, err := protocplugin.ProtoGeneratorMain(protocCgoHandler, os.Stdin, os.Stdout, logPrefix)
	if err != nil {
		log.Fatalf("error: failed to execute protoc plugin handler: %v", err)
	}
}

func protocCgoHandler(request *pluginpb.CodeGeneratorRequest) (genFiles []*pluginpb.CodeGeneratorResponse_File) {
	for _, fd := range request.GetProtoFile() {
		if !slices.Contains(request.FileToGenerate, fd.GetName()) {
			continue
		}

		originalFile := fd.GetName()
		originalFilenameOnly := protocplugin.ExtractFilename(originalFile)
		outName := originalFilenameOnly + ".ygrpc.cgo.go"

		content := fmt.Sprintf(`//go:build ygrpc_cgo
// Code generated by protoc-gen-ygrpc-cgo. DO NOT EDIT.
// source: %s

package ygrpc_cgo
`, originalFile)

		genFiles = append(genFiles, &pluginpb.CodeGeneratorResponse_File{
			Name:    proto.String(outName),
			Content: proto.String(content),
		})
	}

	return genFiles
}
